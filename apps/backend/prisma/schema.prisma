generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  provider  String?
  providerId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms      RoomMember[]
  messages   Message[]
  agents     AgentInstance[]
  mcpServers McpServer[]

  @@unique([provider, providerId])
}

model Room {
  id        String   @id @default(cuid())
  type      String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  RoomMember[]
  messages Message[]
  agents   RoomAgent[]
}

model RoomMember {
  id       String   @id @default(cuid())
  roomId   String
  userId   String
  role     String   @default("MEMBER")
  joinedAt DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([roomId, userId], name: "roomId_userId")
}

model Message {
  id              String   @id @default(cuid())
  roomId          String
  senderId        String?
  senderType      String
  agentInstanceId String?
  kind            String
  text            String?
  createdAt       DateTime @default(now())

  room          Room           @relation(fields: [roomId], references: [id])
  sender        User?          @relation(fields: [senderId], references: [id])
  agentInstance AgentInstance? @relation(fields: [agentInstanceId], references: [id])

  @@index([roomId, createdAt])
}

model AgentInstance {
  id        String   @id @default(cuid())
  userId    String
  name      String
  provider  String
  meta      Json?
  createdAt DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id])
  rooms    RoomAgent[]
  messages Message[]
}

model RoomAgent {
  id              String @id @default(cuid())
  roomId          String
  agentInstanceId String

  room          Room          @relation(fields: [roomId], references: [id])
  agentInstance AgentInstance @relation(fields: [agentInstanceId], references: [id])

  @@unique([roomId, agentInstanceId], name: "roomId_agentInstanceId")
}

model PairingCode {
  code      String   @id
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model McpServer {
  id        String   @id @default(cuid())
  userId    String
  name      String
  command   String
  args      Json?
  envVars   Json?
  status    String   @default("INSTALLED")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
